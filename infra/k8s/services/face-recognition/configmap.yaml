apiVersion: v1
kind: ConfigMap
metadata:
  name: face-recognition-config
  namespace: graduate-project
  labels:
    app: face-recognition
    tier: api
data:
  # ASP.NET Configuration
  ASPNETCORE_URLS: "http://+:8080"
  ASPNETCORE_ENVIRONMENT: "Production"
  
  # Service Discovery (non-sensitive)
  POSTGRES_HOST: "postgres-srv.infrastructure.svc.cluster.local"
  POSTGRES_PORT: "5432"
  REDIS_HOST: "redis-srv.infrastructure.svc.cluster.local" 
  REDIS_PORT: "6379"
  RABBITMQ_HOST: "rabbitmq-srv.infrastructure.svc.cluster.local"
  RABBITMQ_PORT: "5672"
  MONGO_HOST: "mongo-srv.infrastructure.svc.cluster.local"
  MONGO_PORT: "27017"
  
  # Application Settings
  API_VERSION: "v1"
  SERVICE_NAME: "face-recognition"
  
  # Face Recognition Settings
  FaceRecognition__MinConfidence: "0.6"
  FaceRecognition__MaxImageSize: "10485760"
  FaceRecognition__SupportedFormats: "jpg,jpeg,png,bmp,webp"
  FaceRecognition__ModelPath: "/app/models"
  FaceRecognition__EnableGPU: "false"
  FaceRecognition__MaxFacesPerImage: "10"
  FaceRecognition__ProcessingTimeout: "30"
  FaceRecognition__CacheResults: "true"
  FaceRecognition__CacheExpiration: "3600"
  
  # CORS Configuration
  CORS__AllowedOrigins: "http://localhost:3000,https://microservices.local"
  CORS__AllowedMethods: "GET,POST,PUT,DELETE,OPTIONS"
  CORS__AllowedHeaders: "Content-Type,Authorization,X-Requested-With"
  CORS__AllowCredentials: "true"

---
# ============================================
# Face-Recognition AppSettings ConfigMap
# ============================================
# Chứa file appsettings.Production.json
# Mount as file vào /app/appsettings.Production.json
# ============================================

apiVersion: v1
kind: ConfigMap
metadata:
  name: face-recognition-app-config
  namespace: graduate-project
  labels:
    app: face-recognition
    tier: api
data:
  appsettings.Production.json: |
    {
      "Logging": {
        "LogLevel": {
          "Default": "Information",
          "Microsoft": "Warning",
          "Microsoft.Hosting.Lifetime": "Information",
          "Microsoft.AspNetCore.Diagnostics.HealthChecks": "None",
          "Microsoft.AspNetCore.Routing": "None",
          "Microsoft.AspNetCore.Hosting": "Warning",
          "System": "Warning",
          "Zentry.Modules.FaceId": "Debug"
        },
        "Console": {
          "FormatterName": "json",
          "FormatterOptions": {
            "SingleLine": false,
            "IncludeScopes": true,
            "TimestampFormat": "yyyy-MM-dd HH:mm:ss ",
            "UseUtcTimestamp": true,
            "JsonWriterOptions": {
              "Indented": false
            }
          }
        }
      },
      "AllowedHosts": "*",
      "Kestrel": {
        "Endpoints": {
          "Http": {
            "Url": "http://+:8080"
          }
        },
        "Limits": {
          "MaxConcurrentConnections": 100,
          "MaxConcurrentUpgradedConnections": 100,
          "MaxRequestBodySize": 10485760,
          "KeepAliveTimeout": "00:02:00",
          "RequestHeadersTimeout": "00:00:30"
        }
      },
      "FaceRecognition": {
        "MinConfidence": 0.6,
        "MaxImageSize": 10485760,
        "SupportedFormats": ["jpg", "jpeg", "png", "bmp", "webp"],
        "ModelPath": "/app/models",
        "EnableGPU": false,
        "MaxFacesPerImage": 10,
        "ProcessingTimeout": 30,
        "CacheResults": true,
        "CacheExpiration": 3600,
        "ThreadPoolSize": 4,
        "QueueMaxSize": 1000
      },
      "RabbitMQ": {
        "Host": "${RABBITMQ_HOST}",
        "Port": 5672,
        "Username": "${RABBITMQ_USERNAME}",
        "Password": "${RABBITMQ_PASSWORD}",
        "VirtualHost": "/",
        "AutomaticRecoveryEnabled": true,
        "NetworkRecoveryInterval": 10,
        "RequestedHeartbeat": 60,
        "PrefetchCount": 10,
        "Queues": {
          "FaceDetection": "face-detection-queue",
          "FaceRecognition": "face-recognition-queue",
          "DeadLetter": "face-recognition-dlq"
        },
        "Exchanges": {
          "FaceRecognition": "face-recognition-exchange"
        },
        "RetryPolicy": {
          "MaxRetryAttempts": 3,
          "InitialDelay": 1000,
          "MaxDelay": 30000,
          "BackoffMultiplier": 2
        }
      },
      "Redis": {
        "Host": "${REDIS_HOST}",
        "Port": 6379,
        "Password": "${REDIS_PASSWORD}",
        "Database": 0,
        "ConnectTimeout": 5000,
        "SyncTimeout": 5000,
        "ConnectRetry": 3,
        "AbortOnConnectFail": false,
        "AllowAdmin": false,
        "Ssl": false,
        "KeyPrefix": "face-recognition:",
        "DefaultExpiration": 3600
      },
      "HealthChecks": {
        "Endpoints": {
          "Live": "/api/v1/health/live",
          "Ready": "/api/v1/health/ready",
          "Startup": "/api/v1/health/startup"
        },
        "IntervalSeconds": 30,
        "TimeoutSeconds": 10,
        "FailureThreshold": 3
      },
      "CORS": {
        "AllowedOrigins": ["http://localhost:3000", "https://microservices.local"],
        "AllowedMethods": ["GET", "POST", "PUT", "DELETE", "OPTIONS"],
        "AllowedHeaders": ["Content-Type", "Authorization", "X-Requested-With"],
        "AllowCredentials": true,
        "MaxAge": 3600
      },
      "Swagger": {
        "Enabled": false,
        "Title": "Face Recognition API",
        "Version": "v1",
        "Description": "Face Detection and Recognition Service"
      },
      "Metrics": {
        "Enabled": true,
        "Port": 8081,
        "Path": "/metrics"
      }
    }
