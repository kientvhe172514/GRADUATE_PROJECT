apiVersion: batch/v1
kind: CronJob
metadata:
  name: elasticsearch-cleanup
  namespace: monitoring
  labels:
    app: elasticsearch-cleanup
spec:
  schedule: "0 3 * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: elasticsearch-cleanup
        spec:
          restartPolicy: OnFailure
          containers:
            - name: cleanup
              image: curlimages/curl:8.5.0
              command:
                - /bin/sh
                - -c
                - |
                  echo "üóëÔ∏è  Starting Elasticsearch cleanup..."
                  
                  ES_HOST="http://elasticsearch-lb.monitoring.svc.cluster.local:9200"
                  RETENTION_DAYS=7
                  
                  # T√≠nh to√°n ng√†y c·∫ßn x√≥a (logs c≈© h∆°n 7 ng√†y)
                  DELETE_DATE=$(date -d "$RETENTION_DAYS days ago" +%Y.%m.%d)
                  
                  echo "üìÖ Deleting indices older than $DELETE_DATE"
                  
                  # L·∫•y danh s√°ch indices
                  INDICES=$(curl -s "$ES_HOST/_cat/indices/microservices-logs-*?h=index" | sort)
                  
                  # X√≥a t·ª´ng index c≈©
                  for INDEX in $INDICES; do
                    # Extract date from index name (microservices-logs-YYYY.MM.DD)
                    INDEX_DATE=$(echo $INDEX | grep -oP '\d{4}\.\d{2}\.\d{2}')
                    
                    if [ ! -z "$INDEX_DATE" ]; then
                      # Compare dates
                      if [ "$INDEX_DATE" \< "$DELETE_DATE" ]; then
                        echo "üóëÔ∏è  Deleting old index: $INDEX (date: $INDEX_DATE)"
                        curl -X DELETE "$ES_HOST/$INDEX" || echo "‚ö†Ô∏è Failed to delete $INDEX"
                      else
                        echo "‚úÖ Keeping index: $INDEX (date: $INDEX_DATE)"
                      fi
                    fi
                  done
                  
                  # Force merge old indices to reduce segment count
                  echo "üîÑ Force merging recent indices..."
                  YESTERDAY=$(date -d "1 day ago" +%Y.%m.%d)
                  RECENT_INDEX="microservices-logs-$YESTERDAY"
                  
                  curl -X POST "$ES_HOST/$RECENT_INDEX/_forcemerge?max_num_segments=1" || echo "‚ö†Ô∏è Force merge failed"
                  
                  # Show current disk usage
                  echo "üìä Current Elasticsearch stats:"
                  curl -s "$ES_HOST/_cat/indices/microservices-logs-*?v&h=index,docs.count,store.size"
                  
                  echo "‚úÖ Elasticsearch cleanup completed"
              resources:
                requests:
                  cpu: 10m
                  memory: 32Mi
                limits:
                  cpu: 50m
                  memory: 64Mi
