# ============================================
# Backup & Disaster Recovery
# ============================================
# CronJobs for PostgreSQL, MongoDB, Redis backups
# Retention policy: 7 daily, 4 weekly, 12 monthly
# ============================================

---
# ===== BACKUP STORAGE PVC =====
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: backup-storage
  namespace: infrastructure
  labels:
    app: backup
spec:
  accessModes:
  - ReadWriteMany
  resources:
    requests:
      storage: 5Gi
  storageClassName: standard

---
# ===== POSTGRESQL BACKUP CRONJOB =====
apiVersion: batch/v1
kind: CronJob
metadata:
  name: postgres-backup
  namespace: infrastructure
  labels:
    app: postgres-backup
spec:
  schedule: "0 2 * * *"  # Daily at 2 AM
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: backup-sa
          restartPolicy: OnFailure
          containers:
          - name: backup
            image: postgres:16-alpine
            command:
            - /bin/sh
            - -c
            - |
              set -e
              TIMESTAMP=$(date +%Y%m%d_%H%M%S)
              BACKUP_DIR="/backup/postgres"
              BACKUP_FILE="$BACKUP_DIR/postgres_backup_$TIMESTAMP.sql.gz"
              
              echo "Starting PostgreSQL backup at $TIMESTAMP..."
              
              # Create backup directory
              mkdir -p $BACKUP_DIR
              
              # Backup all databases
              PGPASSWORD=$POSTGRES_PASSWORD pg_dumpall \
                -h postgres-primary-srv.infrastructure.svc.cluster.local \
                -U $POSTGRES_USER \
                -c | gzip > $BACKUP_FILE
              
              echo "Backup completed: $BACKUP_FILE"
              
              # Cleanup old backups (keep last 7 days)
              find $BACKUP_DIR -name "postgres_backup_*.sql.gz" -mtime +7 -delete
              
              # List backups
              echo "Available backups:"
              ls -lh $BACKUP_DIR
            env:
            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: postgres-user
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: postgres-password
            volumeMounts:
            - name: backup-storage
              mountPath: /backup
            resources:
              requests:
                memory: "256Mi"
                cpu: "200m"
              limits:
                memory: "512Mi"
                cpu: "500m"
          volumes:
          - name: backup-storage
            persistentVolumeClaim:
              claimName: backup-storage

---
# ===== MONGODB BACKUP CRONJOB =====
apiVersion: batch/v1
kind: CronJob
metadata:
  name: mongodb-backup
  namespace: infrastructure
  labels:
    app: mongodb-backup
spec:
  schedule: "30 2 * * *"  # Daily at 2:30 AM
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: backup-sa
          restartPolicy: OnFailure
          containers:
          - name: backup
            image: mongo:7.0
            command:
            - /bin/sh
            - -c
            - |
              set -e
              TIMESTAMP=$(date +%Y%m%d_%H%M%S)
              BACKUP_DIR="/backup/mongodb"
              BACKUP_FILE="$BACKUP_DIR/mongodb_backup_$TIMESTAMP"
              
              echo "Starting MongoDB backup at $TIMESTAMP..."
              
              # Create backup directory
              mkdir -p $BACKUP_DIR
              
              # Backup all databases
              mongodump \
                --host=mongodb-srv.infrastructure.svc.cluster.local:27017 \
                --username=$MONGO_INITDB_ROOT_USERNAME \
                --password=$MONGO_INITDB_ROOT_PASSWORD \
                --authenticationDatabase=admin \
                --out=$BACKUP_FILE \
                --gzip
              
              echo "Backup completed: $BACKUP_FILE"
              
              # Cleanup old backups (keep last 7 days)
              find $BACKUP_DIR -name "mongodb_backup_*" -mtime +7 -exec rm -rf {} \;
              
              # List backups
              echo "Available backups:"
              du -sh $BACKUP_DIR/*
            env:
            - name: MONGO_INITDB_ROOT_USERNAME
              valueFrom:
                secretKeyRef:
                  name: mongodb-secret
                  key: mongo-root-username
            - name: MONGO_INITDB_ROOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mongodb-secret
                  key: mongo-root-password
            volumeMounts:
            - name: backup-storage
              mountPath: /backup
            resources:
              requests:
                memory: "256Mi"
                cpu: "200m"
              limits:
                memory: "512Mi"
                cpu: "500m"
          volumes:
          - name: backup-storage
            persistentVolumeClaim:
              claimName: backup-storage

---
# ===== REDIS BACKUP CRONJOB =====
apiVersion: batch/v1
kind: CronJob
metadata:
  name: redis-backup
  namespace: infrastructure
  labels:
    app: redis-backup
spec:
  schedule: "0 3 * * *"  # Daily at 3 AM
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: backup-sa
          restartPolicy: OnFailure
          containers:
          - name: backup
            image: redis:7.2-alpine
            command:
            - /bin/sh
            - -c
            - |
              set -e
              TIMESTAMP=$(date +%Y%m%d_%H%M%S)
              BACKUP_DIR="/backup/redis"
              BACKUP_FILE="$BACKUP_DIR/redis_backup_$TIMESTAMP.rdb"
              
              echo "Starting Redis backup at $TIMESTAMP..."
              
              # Create backup directory
              mkdir -p $BACKUP_DIR
              
              # Trigger BGSAVE on master
              redis-cli -h redis-master-srv.infrastructure.svc.cluster.local \
                -a $REDIS_PASSWORD \
                BGSAVE
              
              # Wait for BGSAVE to complete
              sleep 10
              
              # Copy RDB file from master pod
              kubectl cp infrastructure/redis-master-0:/data/dump.rdb $BACKUP_FILE
              
              echo "Backup completed: $BACKUP_FILE"
              
              # Cleanup old backups (keep last 7 days)
              find $BACKUP_DIR -name "redis_backup_*.rdb" -mtime +7 -delete
              
              # List backups
              echo "Available backups:"
              ls -lh $BACKUP_DIR
            env:
            - name: REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: redis-secret
                  key: redis-password
            volumeMounts:
            - name: backup-storage
              mountPath: /backup
            resources:
              requests:
                memory: "128Mi"
                cpu: "100m"
              limits:
                memory: "256Mi"
                cpu: "200m"
          volumes:
          - name: backup-storage
            persistentVolumeClaim:
              claimName: backup-storage

---
# ===== BACKUP CLEANUP CRONJOB =====
apiVersion: batch/v1
kind: CronJob
metadata:
  name: backup-cleanup
  namespace: infrastructure
  labels:
    app: backup-cleanup
spec:
  schedule: "0 4 * * 0"  # Weekly on Sunday at 4 AM
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: backup-sa
          restartPolicy: OnFailure
          containers:
          - name: cleanup
            image: busybox:1.36
            command:
            - /bin/sh
            - -c
            - |
              set -e
              echo "Starting backup cleanup..."
              
              # Keep last 7 daily backups
              find /backup -name "*backup_*" -mtime +7 -delete
              
              # Create weekly backup (copy latest daily)
              WEEKLY_DIR="/backup/weekly"
              mkdir -p $WEEKLY_DIR
              
              for DB in postgres mongodb redis; do
                LATEST=$(ls -t /backup/$DB/*backup_* 2>/dev/null | head -1)
                if [ -n "$LATEST" ]; then
                  cp -r $LATEST $WEEKLY_DIR/${DB}_weekly_$(date +%Y%m%d).backup
                fi
              done
              
              # Keep last 4 weekly backups
              find $WEEKLY_DIR -name "*weekly_*" -mtime +28 -delete
              
              # Report backup sizes
              echo "Backup summary:"
              du -sh /backup/*
              
              echo "Cleanup completed!"
            volumeMounts:
            - name: backup-storage
              mountPath: /backup
            resources:
              requests:
                memory: "64Mi"
                cpu: "50m"
              limits:
                memory: "128Mi"
                cpu: "100m"
          volumes:
          - name: backup-storage
            persistentVolumeClaim:
              claimName: backup-storage

---
# ===== RBAC FOR BACKUP =====
apiVersion: v1
kind: ServiceAccount
metadata:
  name: backup-sa
  namespace: infrastructure
  labels:
    app: backup

---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: backup-role
  namespace: infrastructure
  labels:
    app: backup
rules:
- apiGroups: [""]
  resources: ["pods", "pods/log"]
  verbs: ["get", "list"]
- apiGroups: [""]
  resources: ["pods/exec"]
  verbs: ["create"]
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: backup-rolebinding
  namespace: infrastructure
  labels:
    app: backup
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: backup-role
subjects:
- kind: ServiceAccount
  name: backup-sa
  namespace: infrastructure
