# ============================================
# TRAEFIK INGRESSROUTE - MICROSERVICES ROUTING
# ============================================
# Cấu hình routing cho tất cả microservices
# - Auth: /api/v1/auth → auth-srv:3001/api/v1/auth
# - Face: /api/v1/face → face-recognition-srv:8080/api/v1/face
# - Attendance: /api/v1/attendance → attendance-srv:3002/api/v1/attendance
# - Employee: /api/v1/employee → employee-srv:3003/api/v1/employee
# - Leave: /api/v1/leave → leave-srv:3004/api/v1/leave
# - Notification: /api/v1/notification → notification-srv:3005/api/v1/notification
# - Reporting: /api/v1/reporting → reporting-srv:3006/api/v1/reporting
# ============================================

apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: microservices-ingressroute
  namespace: graduate-project
spec:
  entryPoints:
    - web
  routes:
  # ===== AUTH SERVICE =====
  # /api/v1/auth/** → auth-srv:3001/api/v1/auth/**
  # Swagger: http://TRAEFIK_IP/api/v1/api (vì service có prefix api/v1)
  - match: PathPrefix(`/api/v1/auth`)
    kind: Rule
    services:
    - name: auth-srv
      port: 3001
  
  # ===== FACE RECOGNITION SERVICE =====
  - match: PathPrefix(`/api/v1/face`)
    kind: Rule
    services:
    - name: face-recognition-srv
      port: 8080
  
  # ===== ATTENDANCE SERVICE =====
  - match: PathPrefix(`/api/v1/attendance`)
    kind: Rule
    services:
    - name: attendance-srv
      port: 3002
  
  # ===== EMPLOYEE SERVICE =====
  - match: PathPrefix(`/api/v1/employee`)
    kind: Rule
    services:
    - name: employee-srv
      port: 3003
  
  # ===== LEAVE SERVICE =====
  - match: PathPrefix(`/api/v1/leave`)
    kind: Rule
    services:
    - name: leave-srv
      port: 3004
  
  # ===== NOTIFICATION SERVICE =====
  - match: PathPrefix(`/api/v1/notification`)
    kind: Rule
    services:
    - name: notification-srv
      port: 3005
  
  # ===== REPORTING SERVICE =====
  - match: PathPrefix(`/api/v1/reporting`)
    kind: Rule
    services:
    - name: reporting-srv
      port: 3006

---
# ============================================
# MONITORING INGRESS (Separate namespace)
# ============================================
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: monitoring-ingress
  namespace: monitoring
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/auth-type: basic
    nginx.ingress.kubernetes.io/auth-secret: monitoring-auth
    nginx.ingress.kubernetes.io/auth-realm: 'Authentication Required - Monitoring'
spec:
  rules:
  - host: grafana.microservices.local
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: grafana-srv
            port:
              number: 3030
  - host: prometheus.microservices.local
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: prometheus-srv
            port:
              number: 9090