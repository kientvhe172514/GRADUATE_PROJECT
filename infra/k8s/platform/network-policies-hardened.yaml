# ============================================
# Network Policies - Security Hardening
# ============================================
# Default deny all + explicit allow rules
# Namespace isolation
# ============================================

---
# ===== DEFAULT DENY ALL (Infrastructure Namespace) =====
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-all
  namespace: infrastructure
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress

---
# ===== DEFAULT DENY ALL (Graduate Project Namespace) =====
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-all
  namespace: graduate-project
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress

---
# ===== ALLOW DNS (All Namespaces) =====
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-dns
  namespace: infrastructure
spec:
  podSelector: {}
  policyTypes:
  - Egress
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-dns
  namespace: graduate-project
spec:
  podSelector: {}
  policyTypes:
  - Egress
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53

---
# ===== POSTGRES: Allow from app services =====
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: postgres-allow-ingress
  namespace: infrastructure
spec:
  podSelector:
    matchLabels:
      app: postgres
  policyTypes:
  - Ingress
  ingress:
  # Allow from graduate-project namespace (app services like auth, attendance, etc.)
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: graduate-project
    ports:
    - protocol: TCP
      port: 5432
  # Allow from same namespace (replicas, pgbouncer)
  - from:
    - podSelector:
        matchLabels:
          app: postgres
    - podSelector:
        matchLabels:
          app: pgbouncer
    ports:
    - protocol: TCP
      port: 5432

---
# ===== POSTGRES: Allow egress for replication =====
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: postgres-allow-egress
  namespace: infrastructure
spec:
  podSelector:
    matchLabels:
      app: postgres
  policyTypes:
  - Egress
  egress:
  # Allow to other postgres pods (replication)
  - to:
    - podSelector:
        matchLabels:
          app: postgres
    ports:
    - protocol: TCP
      port: 5432
  # Allow DNS
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
    ports:
    - protocol: UDP
      port: 53

---
# ===== REDIS: Allow from app services =====
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: redis-allow-ingress
  namespace: infrastructure
spec:
  podSelector:
    matchLabels:
      app: redis
  policyTypes:
  - Ingress
  ingress:
  # Allow from graduate-project namespace
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: graduate-project
    ports:
    - protocol: TCP
      port: 6379
  # Allow from same namespace (master-replica, sentinel)
  - from:
    - podSelector:
        matchLabels:
          app: redis
    - podSelector:
        matchLabels:
          app: redis-sentinel
    ports:
    - protocol: TCP
      port: 6379

---
# ===== REDIS SENTINEL: Allow traffic =====
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: redis-sentinel-allow-ingress
  namespace: infrastructure
spec:
  podSelector:
    matchLabels:
      app: redis-sentinel
  policyTypes:
  - Ingress
  ingress:
  # Allow from graduate-project namespace
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: graduate-project
    ports:
    - protocol: TCP
      port: 26379
  # Allow from redis pods
  - from:
    - podSelector:
        matchLabels:
          app: redis
    - podSelector:
        matchLabels:
          app: redis-sentinel
    ports:
    - protocol: TCP
      port: 26379

---
# ===== REDIS: Allow egress =====
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: redis-allow-egress
  namespace: infrastructure
spec:
  podSelector:
    matchLabels:
      app: redis
  policyTypes:
  - Egress
  egress:
  # Allow to other redis pods
  - to:
    - podSelector:
        matchLabels:
          app: redis
    - podSelector:
        matchLabels:
          app: redis-sentinel
    ports:
    - protocol: TCP
      port: 6379
    - protocol: TCP
      port: 26379
  # Allow DNS
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
    ports:
    - protocol: UDP
      port: 53

---
# ===== RABBITMQ: Allow from app services =====
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: rabbitmq-allow-ingress
  namespace: infrastructure
spec:
  podSelector:
    matchLabels:
      app: rabbitmq
  policyTypes:
  - Ingress
  ingress:
  # Allow from graduate-project namespace (app services)
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: graduate-project
    ports:
    - protocol: TCP
      port: 5672  # AMQP
    - protocol: TCP
      port: 15672 # Management UI
  # Allow from same namespace (cluster)
  - from:
    - podSelector:
        matchLabels:
          app: rabbitmq
    ports:
    - protocol: TCP
      port: 5672
    - protocol: TCP
      port: 4369  # EPMD
    - protocol: TCP
      port: 25672 # Inter-node
    - protocol: TCP
      port: 15672

---
# ===== RABBITMQ: Allow egress =====
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: rabbitmq-allow-egress
  namespace: infrastructure
spec:
  podSelector:
    matchLabels:
      app: rabbitmq
  policyTypes:
  - Egress
  egress:
  # Allow to other rabbitmq pods (cluster)
  - to:
    - podSelector:
        matchLabels:
          app: rabbitmq
    ports:
    - protocol: TCP
      port: 5672
    - protocol: TCP
      port: 4369
    - protocol: TCP
      port: 25672
  # Allow to K8s API (for peer discovery)
  - to:
    - namespaceSelector: {}
      podSelector:
        matchLabels:
          component: apiserver
    ports:
    - protocol: TCP
      port: 443
  # Allow DNS
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
    ports:
    - protocol: UDP
      port: 53

---
# ===== AUTH SERVICE: Allow ingress from ingress controller =====
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: auth-allow-ingress
  namespace: graduate-project
spec:
  podSelector:
    matchLabels:
      app: auth
  policyTypes:
  - Ingress
  ingress:
  # Allow from ingress controller
  - from:
    - namespaceSelector:
        matchLabels:
          app.kubernetes.io/name: ingress-nginx
    ports:
    - protocol: TCP
      port: 3001
  # Allow from other services in graduate-project namespace
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: graduate-project
    ports:
    - protocol: TCP
      port: 3001

---
# ===== AUTH SERVICE: Allow egress to infrastructure =====
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: auth-allow-egress
  namespace: graduate-project
spec:
  podSelector:
    matchLabels:
      app: auth
  policyTypes:
  - Egress
  egress:
  # Allow to infrastructure namespace (databases, messaging)
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: infrastructure
    ports:
    - protocol: TCP
      port: 5432  # PostgreSQL
    - protocol: TCP
      port: 6379  # Redis
    - protocol: TCP
      port: 5672  # RabbitMQ
  # Allow to other services in graduate-project namespace
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: graduate-project
  # Allow DNS
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53
  # Allow HTTPS egress (external APIs)
  - ports:
    - protocol: TCP
      port: 443

---
# ===== FACE-RECOGNITION SERVICE: Allow ingress =====
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: face-recognition-allow-ingress
  namespace: graduate-project
spec:
  podSelector:
    matchLabels:
      app: face-recognition
  policyTypes:
  - Ingress
  ingress:
  # Allow from ingress controller
  - from:
    - namespaceSelector:
        matchLabels:
          app.kubernetes.io/name: ingress-nginx
    ports:
    - protocol: TCP
      port: 8080
  # Allow from other services
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: graduate-project
    ports:
    - protocol: TCP
      port: 8080

---
# ===== FACE-RECOGNITION SERVICE: Allow egress =====
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: face-recognition-allow-egress
  namespace: graduate-project
spec:
  podSelector:
    matchLabels:
      app: face-recognition
  policyTypes:
  - Egress
  egress:
  # Allow to infrastructure namespace
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: infrastructure
    ports:
    - protocol: TCP
      port: 5432  # PostgreSQL
    - protocol: TCP
      port: 6379  # Redis
    - protocol: TCP
      port: 5672  # RabbitMQ
  # Allow to other services
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: graduate-project
  # Allow DNS
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
    ports:
    - protocol: UDP
      port: 53
  # Allow HTTPS egress
  - to:
    - namespaceSelector: {}
    ports:
    - protocol: TCP
      port: 443

---
# ===== MONITORING: Allow Prometheus scraping =====
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-prometheus-scraping
  namespace: graduate-project
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: monitoring
      podSelector:
        matchLabels:
          app: prometheus
    ports:
    - protocol: TCP
      port: 8080  # Face recognition metrics
    - protocol: TCP
      port: 8081  # Generic metrics
    - protocol: TCP
      port: 9090  # Prometheus
    - protocol: TCP
      port: 3001  # Auth service metrics
    - protocol: TCP
      port: 3002  # Attendance service metrics
    - protocol: TCP
      port: 3003  # Employee service metrics
    - protocol: TCP
      port: 3004  # Leave service metrics
    - protocol: TCP
      port: 3005  # Notification service metrics
    - protocol: TCP
      port: 3006  # Reporting service metrics

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-prometheus-scraping
  namespace: infrastructure
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: monitoring
      podSelector:
        matchLabels:
          app: prometheus
    ports:
    - protocol: TCP
      port: 9121  # Redis exporter
    - protocol: TCP
      port: 15692 # RabbitMQ Prometheus plugin
    - protocol: TCP
      port: 9187  # PostgreSQL exporter

---
# ============================================
# NEW SERVICES NETWORK POLICIES
# ============================================

# ===== ATTENDANCE SERVICE: Allow ingress =====
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: attendance-allow-ingress
  namespace: graduate-project
spec:
  podSelector:
    matchLabels:
      app: attendance
  policyTypes:
  - Ingress
  ingress:
  # Allow from ingress controller
  - from:
    - namespaceSelector:
        matchLabels:
          app.kubernetes.io/name: ingress-nginx
    ports:
    - protocol: TCP
      port: 3002
  # Allow from other services in default namespace
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: graduate-project
    ports:
    - protocol: TCP
      port: 3002

---
# ===== ATTENDANCE SERVICE: Allow egress =====
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: attendance-allow-egress
  namespace: graduate-project
spec:
  podSelector:
    matchLabels:
      app: attendance
  policyTypes:
  - Egress
  egress:
  # Allow to infrastructure namespace
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: infrastructure
    ports:
    - protocol: TCP
      port: 5432  # PostgreSQL (attendance_db)
    - protocol: TCP
      port: 6379  # Redis
    - protocol: TCP
      port: 5672  # RabbitMQ
  # Allow to other services
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: graduate-project
  # Allow DNS
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
    ports:
    - protocol: UDP
      port: 53
  # Allow HTTPS egress
  - to:
    - namespaceSelector: {}
    ports:
    - protocol: TCP
      port: 443

---
# ===== EMPLOYEE SERVICE: Allow ingress =====
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: employee-allow-ingress
  namespace: graduate-project
spec:
  podSelector:
    matchLabels:
      app: employee
  policyTypes:
  - Ingress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          app.kubernetes.io/name: ingress-nginx
    ports:
    - protocol: TCP
      port: 3003
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: graduate-project
    ports:
    - protocol: TCP
      port: 3003

---
# ===== EMPLOYEE SERVICE: Allow egress =====
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: employee-allow-egress
  namespace: graduate-project
spec:
  podSelector:
    matchLabels:
      app: employee
  policyTypes:
  - Egress
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: infrastructure
    ports:
    - protocol: TCP
      port: 5432  # PostgreSQL (employee_db)
    - protocol: TCP
      port: 6379  # Redis
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: graduate-project
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
    ports:
    - protocol: UDP
      port: 53
  - to:
    - namespaceSelector: {}
    ports:
    - protocol: TCP
      port: 443

---
# ===== LEAVE SERVICE: Allow ingress =====
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: leave-allow-ingress
  namespace: graduate-project
spec:
  podSelector:
    matchLabels:
      app: leave
  policyTypes:
  - Ingress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          app.kubernetes.io/name: ingress-nginx
    ports:
    - protocol: TCP
      port: 3004
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: graduate-project
    ports:
    - protocol: TCP
      port: 3004

---
# ===== LEAVE SERVICE: Allow egress =====
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: leave-allow-egress
  namespace: graduate-project
spec:
  podSelector:
    matchLabels:
      app: leave
  policyTypes:
  - Egress
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: infrastructure
    ports:
    - protocol: TCP
      port: 5432  # PostgreSQL (leave_db)
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: graduate-project
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
    ports:
    - protocol: UDP
      port: 53
  - to:
    - namespaceSelector: {}
    ports:
    - protocol: TCP
      port: 443

---
# ===== NOTIFICATION SERVICE: Allow ingress =====
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: notification-allow-ingress
  namespace: graduate-project
spec:
  podSelector:
    matchLabels:
      app: notification
  policyTypes:
  - Ingress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          app.kubernetes.io/name: ingress-nginx
    ports:
    - protocol: TCP
      port: 3005
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: graduate-project
    ports:
    - protocol: TCP
      port: 3005

---
# ===== NOTIFICATION SERVICE: Allow egress =====
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: notification-allow-egress
  namespace: graduate-project
spec:
  podSelector:
    matchLabels:
      app: notification
  policyTypes:
  - Egress
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: infrastructure
    ports:
    - protocol: TCP
      port: 5432   # PostgreSQL (notification_db)
    - protocol: TCP
      port: 5672   # RabbitMQ
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: graduate-project
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
    ports:
    - protocol: UDP
      port: 53
  - to:
    - namespaceSelector: {}
    ports:
    - protocol: TCP
      port: 443   # External notification APIs (FCM, SMTP, etc.)
    - protocol: TCP
      port: 587   # SMTP
    - protocol: TCP
      port: 465   # SMTPS

---
# ===== REPORTING SERVICE: Allow ingress =====
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: reporting-allow-ingress
  namespace: graduate-project
spec:
  podSelector:
    matchLabels:
      app: reporting
  policyTypes:
  - Ingress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          app.kubernetes.io/name: ingress-nginx
    ports:
    - protocol: TCP
      port: 3006
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: graduate-project
    ports:
    - protocol: TCP
      port: 3006

---
# ===== REPORTING SERVICE: Allow egress =====
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: reporting-allow-egress
  namespace: graduate-project
spec:
  podSelector:
    matchLabels:
      app: reporting
  policyTypes:
  - Egress
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: infrastructure
    ports:
    - protocol: TCP
      port: 5432   # PostgreSQL (primary + read replica for analytics)
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: graduate-project
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
    ports:
    - protocol: UDP
      port: 53
  - to:
    - namespaceSelector: {}
    ports:
    - protocol: TCP
      port: 443   # External analytics/BI tools
