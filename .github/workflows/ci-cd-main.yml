name: ðŸš€ Smart CI/CD Pipeline - AWS EC2

on:
  push:
    branches: [main, develop, KiÃªn]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      service:
        description: 'Force deploy specific service'
        required: false
        type: choice
        options:
          - all
          - auth
          - face-recognition
          - attendance
          - employee
          - leave
          - notification
          - reporting

env:
  AWS_REGION: ap-southeast-1
  REGISTRY: docker.io
  REGISTRY_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}

jobs:
  # ==========================================
  # JOB 1: DETECT CHANGES
  # ==========================================
  detect-changes:
    name: ðŸ” Detect Changed Services
    runs-on: ubuntu-latest
    outputs:
      auth: ${{ steps.filter.outputs.auth }}
      face-recognition: ${{ steps.filter.outputs.face-recognition }}
      attendance: ${{ steps.filter.outputs.attendance }}
      employee: ${{ steps.filter.outputs.employee }}
      leave: ${{ steps.filter.outputs.leave }}
      notification: ${{ steps.filter.outputs.notification }}
      reporting: ${{ steps.filter.outputs.reporting }}
      infra: ${{ steps.filter.outputs.infra }}
      shared: ${{ steps.filter.outputs.shared }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check changed files
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            auth:
              - 'services/auth/**'
              - 'infra/k8s/services/auth/**'
            face-recognition:
              - 'services/face-recognition/**'
              - 'infra/k8s/services/face-recognition/**'
            attendance:
              - 'services/attendance/**'
              - 'infra/k8s/services/attendance/**'
            employee:
              - 'services/employee/**'
              - 'infra/k8s/services/employee/**'
            leave:
              - 'services/leave/**'
              - 'infra/k8s/services/leave/**'
            notification:
              - 'services/notification/**'
              - 'infra/k8s/services/notification/**'
            reporting:
              - 'services/reporting/**'
              - 'infra/k8s/services/reporting/**'
            infra:
              - 'infra/k8s/platform/**'
              - 'infra/k8s/shared/**'
            shared:
              - 'services/shared-common/**'
              - 'pnpm-lock.yaml'
              - 'package.json'

      - name: Print detected changes
        run: |
          echo "ðŸ” Changed Services:"
          echo "Auth: ${{ steps.filter.outputs.auth }}"
          echo "Face Recognition: ${{ steps.filter.outputs.face-recognition }}"
          echo "Attendance: ${{ steps.filter.outputs.attendance }}"
          echo "Employee: ${{ steps.filter.outputs.employee }}"
          echo "Leave: ${{ steps.filter.outputs.leave }}"
          echo "Notification: ${{ steps.filter.outputs.notification }}"
          echo "Reporting: ${{ steps.filter.outputs.reporting }}"
          echo "Infrastructure: ${{ steps.filter.outputs.infra }}"
          echo "Shared: ${{ steps.filter.outputs.shared }}"

  # ==========================================
  # JOB 2: BUILD SHARED COMMON (IF CHANGED)
  # ==========================================
  build-shared:
    name: ðŸ“¦ Build Shared Common
    needs: detect-changes
    if: needs.detect-changes.outputs.shared == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build shared-common
        run: pnpm --filter @graduate-project/shared-common build

      - name: Cache shared build
        uses: actions/cache@v4
        with:
          path: services/shared-common/dist
          key: shared-build-${{ github.sha }}

  # ==========================================
  # JOB 3: BUILD & PUSH AUTH SERVICE
  # ==========================================
  build-auth:
    name: ðŸ” Build Auth Service
    needs: [detect-changes, build-shared]
    if: |
      always() &&
      (needs.detect-changes.outputs.auth == 'true' || 
       needs.detect-changes.outputs.shared == 'true' ||
       github.event.inputs.service == 'all' ||
       github.event.inputs.service == 'auth')
    uses: ./.github/workflows/build-service.yml
    with:
      service-name: auth
      service-path: services/auth
      dockerfile: Dockerfile
      build-args: |
        NODE_ENV=production
    secrets: inherit

  # ==========================================
  # JOB 4: BUILD & PUSH FACE RECOGNITION
  # ==========================================
  build-face-recognition:
    name: ðŸ‘¤ Build Face Recognition Service
    needs: [detect-changes]
    if: |
      always() &&
      (needs.detect-changes.outputs.face-recognition == 'true' ||
       github.event.inputs.service == 'all' ||
       github.event.inputs.service == 'face-recognition')
    uses: ./.github/workflows/build-dotnet-service.yml
    with:
      service-name: face-recognition
      service-path: services/face-recognition
      dockerfile: src/Zentry.API/Dockerfile
      build-args: |
        ASPNETCORE_ENVIRONMENT=Production
    secrets: inherit

  # ==========================================
  # JOB 5: BUILD & PUSH ATTENDANCE SERVICE
  # ==========================================
  build-attendance:
    name: â° Build Attendance Service
    needs: [detect-changes, build-shared]
    if: |
      always() &&
      (needs.detect-changes.outputs.attendance == 'true' ||
       needs.detect-changes.outputs.shared == 'true' ||
       github.event.inputs.service == 'all' ||
       github.event.inputs.service == 'attendance')
    uses: ./.github/workflows/build-service.yml
    with:
      service-name: attendance
      service-path: services/attendance
      dockerfile: Dockerfile
      build-args: |
        NODE_ENV=production
    secrets: inherit

  # ==========================================
  # JOB 6: BUILD & PUSH EMPLOYEE SERVICE
  # ==========================================
  build-employee:
    name: ðŸ‘¥ Build Employee Service
    needs: [detect-changes, build-shared]
    if: |
      always() &&
      (needs.detect-changes.outputs.employee == 'true' ||
       needs.detect-changes.outputs.shared == 'true' ||
       github.event.inputs.service == 'all' ||
       github.event.inputs.service == 'employee')
    uses: ./.github/workflows/build-service.yml
    with:
      service-name: employee
      service-path: services/employee
      dockerfile: Dockerfile
      build-args: |
        NODE_ENV=production
    secrets: inherit

  # ==========================================
  # JOB 7: BUILD & PUSH LEAVE SERVICE
  # ==========================================
  build-leave:
    name: ðŸ–ï¸ Build Leave Service
    needs: [detect-changes, build-shared]
    if: |
      always() &&
      (needs.detect-changes.outputs.leave == 'true' ||
       needs.detect-changes.outputs.shared == 'true' ||
       github.event.inputs.service == 'all' ||
       github.event.inputs.service == 'leave')
    uses: ./.github/workflows/build-service.yml
    with:
      service-name: leave
      service-path: services/leave
      dockerfile: Dockerfile
      build-args: |
        NODE_ENV=production
    secrets: inherit

  # ==========================================
  # JOB 8: BUILD & PUSH NOTIFICATION SERVICE
  # ==========================================
  build-notification:
    name: ðŸ”” Build Notification Service
    needs: [detect-changes, build-shared]
    if: |
      always() &&
      (needs.detect-changes.outputs.notification == 'true' ||
       needs.detect-changes.outputs.shared == 'true' ||
       github.event.inputs.service == 'all' ||
       github.event.inputs.service == 'notification')
    uses: ./.github/workflows/build-service.yml
    with:
      service-name: notification
      service-path: services/notification
      dockerfile: Dockerfile
      build-args: |
        NODE_ENV=production
    secrets: inherit

  # ==========================================
  # JOB 9: BUILD & PUSH REPORTING SERVICE
  # ==========================================
  build-reporting:
    name: ðŸ“Š Build Reporting Service
    needs: [detect-changes, build-shared]
    if: |
      always() &&
      (needs.detect-changes.outputs.reporting == 'true' ||
       needs.detect-changes.outputs.shared == 'true' ||
       github.event.inputs.service == 'all' ||
       github.event.inputs.service == 'reporting')
    uses: ./.github/workflows/build-service.yml
    with:
      service-name: reporting
      service-path: services/reporting
      dockerfile: Dockerfile
      build-args: |
        NODE_ENV=production
    secrets: inherit

  # ==========================================
  # JOB 10: DEPLOY TO AWS EC2
  # ==========================================
  deploy-to-ec2:
    name: ðŸš€ Deploy to AWS EC2
    needs: 
      - detect-changes
      - build-auth
      - build-face-recognition
      - build-attendance
      - build-employee
      - build-leave
      - build-notification
      - build-reporting
    if: |
      always() &&
      (needs.detect-changes.outputs.auth == 'true' ||
       needs.detect-changes.outputs.face-recognition == 'true' ||
       needs.detect-changes.outputs.attendance == 'true' ||
       needs.detect-changes.outputs.employee == 'true' ||
       needs.detect-changes.outputs.leave == 'true' ||
       needs.detect-changes.outputs.notification == 'true' ||
       needs.detect-changes.outputs.reporting == 'true' ||
       needs.detect-changes.outputs.infra == 'true' ||
       github.event.inputs.service != '')
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Setup infrastructure secrets and deploy
        if: needs.detect-changes.outputs.infra == 'true'
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            set -e
            cd ~/GRADUATE_PROJECT
            git pull origin main
            
            # ============================================
            # CREATE POSTGRES SECRET (7 DATABASES)
            # ============================================
            cat > /tmp/postgres-secret.yaml << 'YAML'
            apiVersion: v1
            kind: Secret
            metadata:
              name: postgres-secret
              namespace: graduate-project
            type: Opaque
            stringData:
              POSTGRES_HOST: "${{ secrets.POSTGRES_HOST }}"
              POSTGRES_PORT: "${{ secrets.POSTGRES_PORT }}"
              POSTGRES_USER: "${{ secrets.POSTGRES_USER }}"
              POSTGRES_PASSWORD: "${{ secrets.POSTGRES_PASSWORD }}"
              POSTGRES_DB_IAM: "${{ secrets.POSTGRES_DB_IAM }}"
              POSTGRES_DB_ATTENDANCE: "${{ secrets.POSTGRES_DB_ATTENDANCE }}"
              POSTGRES_DB_EMPLOYEE: "${{ secrets.POSTGRES_DB_EMPLOYEE }}"
              POSTGRES_DB_LEAVE: "${{ secrets.POSTGRES_DB_LEAVE }}"
              POSTGRES_DB_NOTIFICATION: "${{ secrets.POSTGRES_DB_NOTIFICATION }}"
              POSTGRES_DB_REPORTING: "${{ secrets.POSTGRES_DB_REPORTING }}"
              POSTGRES_DB_ZENTRY: "${{ secrets.POSTGRES_DB_ZENTRY }}"
            YAML
            
            # ============================================
            # CREATE MONGODB SECRET
            # ============================================
            cat > /tmp/mongodb-secret.yaml << 'YAML'
            apiVersion: v1
            kind: Secret
            metadata:
              name: mongodb-secret
              namespace: graduate-project
            type: Opaque
            stringData:
              MONGODB_HOST: "${{ secrets.MONGODB_HOST }}"
              MONGODB_PORT: "${{ secrets.MONGODB_PORT }}"
              MONGODB_DATABASE: "${{ secrets.MONGODB_DATABASE }}"
              MONGODB_USERNAME: "${{ secrets.MONGODB_USERNAME }}"
              MONGODB_PASSWORD: "${{ secrets.MONGODB_PASSWORD }}"
            YAML
            
            # ============================================
            # CREATE RABBITMQ SECRET
            # ============================================
            cat > /tmp/rabbitmq-secret.yaml << 'YAML'
            apiVersion: v1
            kind: Secret
            metadata:
              name: rabbitmq-secret
              namespace: graduate-project
            type: Opaque
            stringData:
              RABBITMQ_HOST: "${{ secrets.RABBITMQ_HOST }}"
              RABBITMQ_PORT: "${{ secrets.RABBITMQ_PORT }}"
              RABBITMQ_USERNAME: "${{ secrets.RABBITMQ_USERNAME }}"
              RABBITMQ_PASSWORD: "${{ secrets.RABBITMQ_PASSWORD }}"
              RABBITMQ_MANAGEMENT_PORT: "${{ secrets.RABBITMQ_MANAGEMENT_PORT }}"
            YAML
            
            # ============================================
            # CREATE REDIS SECRET
            # ============================================
            cat > /tmp/redis-secret.yaml << 'YAML'
            apiVersion: v1
            kind: Secret
            metadata:
              name: redis-secret
              namespace: graduate-project
            type: Opaque
            stringData:
              REDIS_HOST: "${{ secrets.REDIS_HOST }}"
              REDIS_PORT: "${{ secrets.REDIS_PORT }}"
              REDIS_PASSWORD: "${{ secrets.REDIS_PASSWORD }}"
            YAML
            
            # Apply all infrastructure secrets
            kubectl apply -f /tmp/postgres-secret.yaml
            kubectl apply -f /tmp/mongodb-secret.yaml
            kubectl apply -f /tmp/rabbitmq-secret.yaml
            kubectl apply -f /tmp/redis-secret.yaml
            
            # Cleanup temp files
            rm /tmp/postgres-secret.yaml /tmp/mongodb-secret.yaml /tmp/rabbitmq-secret.yaml /tmp/redis-secret.yaml
            
            # Deploy infrastructure
            kubectl apply -f infra/k8s/platform/
            kubectl apply -f infra/k8s/shared/
            
            echo "âœ… Infrastructure secrets (14 secrets total) and deployments updated"
          EOF

      - name: Deploy Auth Service
        if: |
          needs.detect-changes.outputs.auth == 'true' ||
          needs.detect-changes.outputs.shared == 'true' ||
          github.event.inputs.service == 'all' ||
          github.event.inputs.service == 'auth'
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            set -e
            cd ~/GRADUATE_PROJECT
            git pull origin main
            
            # ============================================
            # CREATE AUTH SERVICE SECRET (1 Gá»˜P)
            # ============================================
            cat > /tmp/auth-secret.yaml << 'YAML'
            apiVersion: v1
            kind: Secret
            metadata:
              name: auth-secret
              namespace: graduate-project
            type: Opaque
            stringData:
              .env: |
                ${{ secrets.AUTH_SECRET }}
            YAML
            
            # Apply secret
            kubectl apply -f /tmp/auth-secret.yaml
            rm /tmp/auth-secret.yaml
            
            # Apply/Update K8s deployment
            kubectl apply -f infra/k8s/services/auth/
            
            # Update deployment image
            kubectl set image deployment/auth-depl auth=${{ secrets.DOCKERHUB_USERNAME }}/graduate-project-auth:${{ github.sha }} -n graduate-project
            
            # Restart to pick up new secrets
            kubectl rollout restart deployment/auth-depl -n graduate-project
            kubectl rollout status deployment/auth-depl -n graduate-project --timeout=5m
            
            echo "âœ… Auth service deployed with consolidated secret"
          EOF

      - name: Deploy Attendance Service
        if: |
          needs.detect-changes.outputs.attendance == 'true' ||
          needs.detect-changes.outputs.shared == 'true' ||
          github.event.inputs.service == 'all' ||
          github.event.inputs.service == 'attendance'
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            set -e
            cd ~/GRADUATE_PROJECT
            git pull origin main
            
            # CREATE ATTENDANCE SERVICE SECRET (1 Gá»˜P)
            cat > /tmp/attendance-secret.yaml << 'YAML'
            apiVersion: v1
            kind: Secret
            metadata:
              name: attendance-secret
              namespace: graduate-project
            type: Opaque
            stringData:
              .env: |
                ${{ secrets.ATTENDANCE_SECRET }}
            YAML
            
            kubectl apply -f /tmp/attendance-secret.yaml
            rm /tmp/attendance-secret.yaml
            
            kubectl apply -f infra/k8s/services/attendance/
            kubectl set image deployment/attendance-depl attendance=${{ secrets.DOCKERHUB_USERNAME }}/graduate-project-attendance:${{ github.sha }} -n graduate-project
            kubectl rollout restart deployment/attendance-depl -n graduate-project
            kubectl rollout status deployment/attendance-depl -n graduate-project --timeout=5m
            
            echo "âœ… Attendance service deployed"
          EOF

      - name: Deploy Employee Service
        if: |
          needs.detect-changes.outputs.employee == 'true' ||
          needs.detect-changes.outputs.shared == 'true' ||
          github.event.inputs.service == 'all' ||
          github.event.inputs.service == 'employee'
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            set -e
            cd ~/GRADUATE_PROJECT
            git pull origin main
            
            # CREATE EMPLOYEE SERVICE SECRET (1 Gá»˜P)
            cat > /tmp/employee-secret.yaml << 'YAML'
            apiVersion: v1
            kind: Secret
            metadata:
              name: employee-secret
              namespace: graduate-project
            type: Opaque
            stringData:
              .env: |
                ${{ secrets.EMPLOYEE_SECRET }}
            YAML
            
            kubectl apply -f /tmp/employee-secret.yaml
            rm /tmp/employee-secret.yaml
            
            kubectl apply -f infra/k8s/services/employee/
            kubectl set image deployment/employee-depl employee=${{ secrets.DOCKERHUB_USERNAME }}/graduate-project-employee:${{ github.sha }} -n graduate-project
            kubectl rollout restart deployment/employee-depl -n graduate-project
            kubectl rollout status deployment/employee-depl -n graduate-project --timeout=5m
            
            echo "âœ… Employee service deployed"
          EOF

      - name: Deploy Leave Service
        if: |
          needs.detect-changes.outputs.leave == 'true' ||
          needs.detect-changes.outputs.shared == 'true' ||
          github.event.inputs.service == 'all' ||
          github.event.inputs.service == 'leave'
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            set -e
            cd ~/GRADUATE_PROJECT
            git pull origin main
            
            # CREATE LEAVE SERVICE SECRET (1 Gá»˜P)
            cat > /tmp/leave-secret.yaml << 'YAML'
            apiVersion: v1
            kind: Secret
            metadata:
              name: leave-secret
              namespace: graduate-project
            type: Opaque
            stringData:
              .env: |
                ${{ secrets.LEAVE_SECRET }}
            YAML
            
            kubectl apply -f /tmp/leave-secret.yaml
            rm /tmp/leave-secret.yaml
            
            kubectl apply -f infra/k8s/services/leave/
            kubectl set image deployment/leave-depl leave=${{ secrets.DOCKERHUB_USERNAME }}/graduate-project-leave:${{ github.sha }} -n graduate-project
            kubectl rollout restart deployment/leave-depl -n graduate-project
            kubectl rollout status deployment/leave-depl -n graduate-project --timeout=5m
            
            echo "âœ… Leave service deployed"
          EOF

      - name: Deploy Notification Service
        if: |
          needs.detect-changes.outputs.notification == 'true' ||
          needs.detect-changes.outputs.shared == 'true' ||
          github.event.inputs.service == 'all' ||
          github.event.inputs.service == 'notification'
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            set -e
            cd ~/GRADUATE_PROJECT
            git pull origin main
            
            # CREATE NOTIFICATION SERVICE SECRET (1 Gá»˜P)
            cat > /tmp/notification-secret.yaml << 'YAML'
            apiVersion: v1
            kind: Secret
            metadata:
              name: notification-secret
              namespace: graduate-project
            type: Opaque
            stringData:
              .env: |
                ${{ secrets.NOTIFICATION_SECRET }}
            YAML
            
            kubectl apply -f /tmp/notification-secret.yaml
            rm /tmp/notification-secret.yaml
            
            kubectl apply -f infra/k8s/services/notification/
            kubectl set image deployment/notification-depl notification=${{ secrets.DOCKERHUB_USERNAME }}/graduate-project-notification:${{ github.sha }} -n graduate-project
            kubectl rollout restart deployment/notification-depl -n graduate-project
            kubectl rollout status deployment/notification-depl -n graduate-project --timeout=5m
            
            echo "âœ… Notification service deployed"
          EOF

      - name: Deploy Reporting Service
        if: |
          needs.detect-changes.outputs.reporting == 'true' ||
          needs.detect-changes.outputs.shared == 'true' ||
          github.event.inputs.service == 'all' ||
          github.event.inputs.service == 'reporting'
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            set -e
            cd ~/GRADUATE_PROJECT
            git pull origin main
            
            # CREATE REPORTING SERVICE SECRET (1 Gá»˜P)
            cat > /tmp/reporting-secret.yaml << 'YAML'
            apiVersion: v1
            kind: Secret
            metadata:
              name: reporting-secret
              namespace: graduate-project
            type: Opaque
            stringData:
              .env: |
                ${{ secrets.REPORTING_SECRET }}
            YAML
            
            kubectl apply -f /tmp/reporting-secret.yaml
            rm /tmp/reporting-secret.yaml
            
            kubectl apply -f infra/k8s/services/reporting/
            kubectl set image deployment/reporting-depl reporting=${{ secrets.DOCKERHUB_USERNAME }}/graduate-project-reporting:${{ github.sha }} -n graduate-project
            kubectl rollout restart deployment/reporting-depl -n graduate-project
            kubectl rollout status deployment/reporting-depl -n graduate-project --timeout=5m
            
            echo "âœ… Reporting service deployed"
          EOF

      - name: Deploy Face Recognition Service
        if: |
          needs.detect-changes.outputs.face-recognition == 'true' ||
          github.event.inputs.service == 'all' ||
          github.event.inputs.service == 'face-recognition'
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            set -e
            cd ~/GRADUATE_PROJECT
            git pull origin main
            
            # CREATE FACE RECOGNITION SERVICE SECRET (1 Gá»˜P)
            cat > /tmp/face-recognition-secret.yaml << 'YAML'
            apiVersion: v1
            kind: Secret
            metadata:
              name: face-recognition-secret
              namespace: graduate-project
            type: Opaque
            stringData:
              .env: |
                ${{ secrets.FACE_RECOGNITION_SECRET }}
            YAML
            
            kubectl apply -f /tmp/face-recognition-secret.yaml
            rm /tmp/face-recognition-secret.yaml
            
            kubectl apply -f infra/k8s/services/face-recognition/
            kubectl set image deployment/face-recognition-depl face-recognition=${{ secrets.DOCKERHUB_USERNAME }}/graduate-project-face-recognition:${{ github.sha }} -n graduate-project
            kubectl rollout restart deployment/face-recognition-depl -n graduate-project
            kubectl rollout status deployment/face-recognition-depl -n graduate-project --timeout=5m
            
            echo "âœ… Face Recognition service deployed"
          EOF

      - name: Verify deployment
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            echo "ðŸ“Š Deployment Status:"
            echo ""
            echo "=== Pods in graduate-project namespace ==="
            kubectl get pods -n graduate-project
            echo ""
            echo "=== Services in graduate-project namespace ==="
            kubectl get svc -n graduate-project
            echo ""
            echo "=== Secrets in graduate-project namespace ==="
            kubectl get secrets -n graduate-project
          EOF

  # ==========================================
  # JOB 11: NOTIFY DEPLOYMENT STATUS
  # ==========================================
  notify:
    name: ðŸ“¢ Notify Deployment Status
    needs: deploy-to-ec2
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: Send Slack notification
        if: vars.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "ðŸš€ Deployment to AWS EC2",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Deployment Status:* ${{ needs.deploy-to-ec2.result }}\n*Branch:* ${{ github.ref_name }}\n*Commit:* ${{ github.sha }}\n*Author:* ${{ github.actor }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
