# ============================================
# TRAEFIK INGRESSROUTE - MICROSERVICES ROUTING
# ============================================
# Cấu hình routing cho tất cả microservices
# - Auth: /api/v1/auth → auth-srv:3001/api/v1/auth
# - Face: /api/v1/face → face-recognition-srv:8080/api/v1/face
# - Attendance: /api/v1/attendance → attendance-srv:3002/api/v1/attendance
# - Employee: /api/v1/employee → employee-srv:3003/api/v1/employee
# - Leave: /api/v1/leave → leave-srv:3004/api/v1/leave
# - Notification: /api/v1/notification → notification-srv:3005/api/v1/notification
# - Reporting: /api/v1/reporting → reporting-srv:3006/api/v1/reporting
# ============================================

# ============================================
# TRAEFIK MIDDLEWARE - AUTH FORWARD
# ============================================
# ForwardAuth Middleware để verify JWT với Auth Service
# ✅ ONLY 5 HEADERS: X-User-Id, X-User-Email, X-User-Roles, X-User-Permissions, X-Employee-Id
# ============================================
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: auth-forward
  namespace: graduate-project
spec:
  forwardAuth:
    address: http://auth-srv.graduate-project.svc.cluster.local:3001/api/v1/auth/verify
    authResponseHeaders:
      - X-User-Id
      - X-User-Email
      - X-User-Roles
      - X-User-Permissions
      - X-Employee-Id

---
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: microservices-ingressroute
  namespace: graduate-project
spec:
  entryPoints:
    - web
  routes:
  # ===== SWAGGER UI ROUTES (PUBLIC - No Auth) =====
  # Priority cao để match trước API routes
  
  - match: PathPrefix(`/auth/swagger`) || PathPrefix(`/api/v1/auth/auth/swagger`)
    kind: Rule
    priority: 100
    services:
    - name: auth-srv
      namespace: graduate-project
      port: 3001
  
  - match: PathPrefix(`/attendance/swagger`) || PathPrefix(`/api/v1/attendance/attendance/swagger`)
    kind: Rule
    priority: 100
    services:
    - name: attendance-srv
      namespace: graduate-project
      port: 3002
  
  - match: PathPrefix(`/employee/swagger`) || PathPrefix(`/api/v1/employee/employee/swagger`)
    kind: Rule
    priority: 100
    services:
    - name: employee-srv
      namespace: graduate-project
      port: 3003
  
  - match: PathPrefix(`/leave/swagger`) || PathPrefix(`/api/v1/leave/leave/swagger`)
    kind: Rule
    priority: 100
    services:
    - name: leave-srv
      namespace: graduate-project
      port: 3004
  
  - match: PathPrefix(`/notification/swagger`) || PathPrefix(`/api/v1/notification/notification/swagger`)
    kind: Rule
    priority: 100
    services:
    - name: notification-srv
      namespace: graduate-project
      port: 3005
  
  - match: PathPrefix(`/reporting/swagger`) || PathPrefix(`/api/v1/reporting/reporting/swagger`)
    kind: Rule
    priority: 100
    services:
    - name: reporting-srv
      namespace: graduate-project
      port: 3006
  
  # ===== PROMETHEUS METRICS ROUTES (PUBLIC - NO AUTH) =====
  # ⚠️ CRITICAL: /metrics MUST be public - used by Prometheus scraper
  # ⚠️ MUST NOT route through Ingress - Prometheus scrapes pods directly via ServiceMonitor
  # This route is kept for backward compatibility only
  
  # ❌ REMOVED: Metrics should NOT go through Ingress
  # Prometheus uses kubernetes_sd_configs to discover and scrape pods directly
  # See: prometheus-configmap.yaml > job 'microservices'
  
  # ===== AUTH SERVICE API =====
  # PUBLIC ROUTES (No Auth Required): /login, /register, /refresh, /verify
  # ⚠️ CRITICAL: /verify MUST be public - used by Traefik ForwardAuth middleware
  - match: PathPrefix(`/api/v1/auth/login`) || PathPrefix(`/api/v1/auth/register`) || PathPrefix(`/api/v1/auth/refresh`) || PathPrefix(`/api/v1/auth/verify`) || PathPrefix(`/api/v1/auth/forgot-password`) || PathPrefix(`/api/v1/auth/reset-password`)
    kind: Rule
    priority: 20
    services:
    - name: auth-srv
      namespace: graduate-project
      port: 3001
  
  # PROTECTED ROUTES (Auth Required): /verify, /me, /logout, etc.
  - match: PathPrefix(`/api/v1/auth`)
    kind: Rule
    middlewares:
      - name: auth-forward
        namespace: graduate-project
    priority: 10
    services:
    - name: auth-srv
      namespace: graduate-project
      port: 3001
  
  # ===== FACE RECOGNITION SERVICE (PROTECTED) =====
  # /api/v1/face/** → face-recognition-srv:8080/api/v1/face/**
  # Requires JWT authentication via auth-forward middleware
  - match: PathPrefix(`/api/v1/face`)
    kind: Rule
    priority: 10
    services:
    - name: face-recognition-srv
      namespace: graduate-project
      port: 8080
  
  # ===== ATTENDANCE SERVICE (PROTECTED) =====
  # /api/v1/attendance/** → attendance-srv:3002/api/v1/attendance/**
  # Requires JWT authentication via auth-forward middleware
  - match: PathPrefix(`/api/v1/attendance`)
    kind: Rule
    middlewares:
      - name: auth-forward
        namespace: graduate-project
    services:
    - name: attendance-srv
      namespace: graduate-project
      port: 3002
  
  # ===== EMPLOYEE SERVICE (PROTECTED) =====
  # /api/v1/employee/** → employee-srv:3003/api/v1/employee/**
  # Requires JWT authentication via auth-forward middleware
  - match: PathPrefix(`/api/v1/employee`)
    kind: Rule
    middlewares:
      - name: auth-forward
        namespace: graduate-project
    services:
    - name: employee-srv
      namespace: graduate-project
      port: 3003
  
  # ===== LEAVE SERVICE (PROTECTED) =====
  # /api/v1/leave/** → leave-srv:3004/api/v1/leave/**
  # Requires JWT authentication via auth-forward middleware
  - match: PathPrefix(`/api/v1/leave`)
    kind: Rule
    middlewares:
      - name: auth-forward
        namespace: graduate-project
    services:
    - name: leave-srv
      namespace: graduate-project
      port: 3004
  
  # ===== NOTIFICATION SERVICE (PROTECTED) =====
  # /api/v1/notification/** → notification-srv:3005/api/v1/notification/**
  # Requires JWT authentication via auth-forward middleware
  - match: PathPrefix(`/api/v1/notification`)
    kind: Rule
    middlewares:
      - name: auth-forward
        namespace: graduate-project
    services:
    - name: notification-srv
      namespace: graduate-project
      port: 3005
  
  # ===== REPORTING SERVICE (PROTECTED) =====
  # /api/v1/reporting/** → reporting-srv:3006/api/v1/reporting/**
  # Requires JWT authentication via auth-forward middleware
  - match: PathPrefix(`/api/v1/reporting`)
    kind: Rule
    middlewares:
      - name: auth-forward
        namespace: graduate-project
    services:
    - name: reporting-srv
      namespace: graduate-project
      port: 3006

---
# ============================================
# MONITORING INGRESS - Grafana (Traefik)
# ============================================
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: grafana-ingressroute
  namespace: monitoring
spec:
  entryPoints:
    - web
  routes:
  - match: Host(`grafana.microservices.local`) || Host(`grafana.localhost`) || PathPrefix(`/grafana`)
    kind: Rule
    services:
    - name: grafana-srv
      namespace: monitoring
      port: 3030

---
# ============================================
# MONITORING INGRESS - Prometheus (Traefik)
# ============================================
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: prometheus-ingressroute
  namespace: monitoring
spec:
  entryPoints:
    - web
  routes:
  - match: Host(`prometheus.microservices.local`) || Host(`prometheus.localhost`) || PathPrefix(`/prometheus`)
    kind: Rule
    services:
    - name: prometheus-srv
      namespace: monitoring
      port: 9090
