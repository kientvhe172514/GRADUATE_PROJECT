name: Deploy Services to Production

# Kích hoạt workflow khi có push lên branch 'main'
on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # Bước 1: Lấy mã nguồn về
      - name: Checkout code
        uses: actions/checkout@v3

      # Bước 2: Đăng nhập vào Docker Hub (chỉ làm 1 lần)
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # --- Bước 3: Build và Đẩy image cho từng service (THÔNG MINH) ---

      # --- AUTH SERVICE ---
      - name: Build and push Auth Service
        # 'if' condition: Chỉ chạy bước này nếu có file thay đổi trong thư mục 'services/auth/'
        if: |
          contains(join(github.event.commits.*.modified, ' '), 'services/auth/') ||
          contains(join(github.event.commits.*.added, ' '), 'services/auth/')
        uses: docker/build-push-action@v4
        with:
          context: ./services/auth
          push: true
          tags: tranvukien125/auth-service:latest

      # --- STUDENT SERVICE ---
      - name: Build and push Student Service
        if: |
          contains(join(github.event.commits.*.modified, ' '), 'services/student/') ||
          contains(join(github.event.commits.*.added, ' '), 'services/student/')
        uses: docker/build-push-action@v4
        with:
          context: ./services/student
          push: true
          tags: tranvukien125/student-service:latest
      
      # --- NEXTJS WEB ---
      - name: Build and push Next.js Web
        if: |
          contains(join(github.event.commits.*.modified, ' '), 'clients/nextjs_web/') ||
          contains(join(github.event.commits.*.added, ' '), 'clients/nextjs_web/')
        uses: docker/build-push-action@v4
        with:
          context: ./clients/nextjs_web
          push: true
          tags: tranvukien125/nextjs-web:latest

      # --- Thêm các bước build tương tự cho các service còn lại (face-recognition, attendance...) ---

      # Bước 4: Deploy lên Kubernetes trên VPS
      - name: Deploy to VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            # Di chuyển đến thư mục dự án trên VPS
            cd /đường/dẫn/tới/dự/án/trên/vps 
            
            # Cập nhật mã nguồn mới nhất (chứa các file .yaml)
            git pull
            
            # Ra lệnh cho Kubernetes áp dụng lại toàn bộ cấu hình.
            # Kubernetes đủ thông minh để chỉ cập nhật những gì đã thay đổi.
            # Nó sẽ tự động kéo về các image mới nhất mà bạn vừa đẩy lên.
            sudo k3s kubectl apply -f infra/k8s