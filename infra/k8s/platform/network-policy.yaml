# ============================================
# Simplified Network Policy for GRADUATE_PROJECT
# Single source of truth to avoid conflicts.
# ============================================

---
# Rule 1: DEFAULT-DENY in each namespace
# Deny all traffic by default unless explicitly allowed.
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-all
  namespace: graduate-project
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-all
  namespace: infrastructure
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress

---
# Rule 2: ALLOW DNS (MOST IMPORTANT)
# Allow ALL pods in both namespaces to query DNS.
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-dns-queries
  namespace: graduate-project
spec:
  podSelector: {}
  policyTypes:
  - Egress
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
      podSelector:
        matchLabels:
          k8s-app: kube-dns
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-dns-queries
  namespace: infrastructure
spec:
  podSelector: {}
  policyTypes:
  - Egress
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
      podSelector:
        matchLabels:
          k8s-app: kube-dns
    ports:
    - protocol: UDP
      port: 53
    - protocol: TCP
      port: 53

---
# Rule 3: ALLOW ALL CROSS-NAMESPACE TRAFFIC
# Allow pods in 'graduate-project' to talk to 'infrastructure' and vice-versa.
# This is a broad rule to ensure connectivity. We can tighten it later if needed.
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-cross-namespace-comm
  namespace: graduate-project
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: infrastructure
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: infrastructure
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-cross-namespace-comm
  namespace: infrastructure
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: graduate-project
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: graduate-project

---
# Rule 4: ALLOW IN-NAMESPACE COMMUNICATION
# Allow pods within the same namespace to talk to each other.
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-intra-namespace
  namespace: graduate-project
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - podSelector: {}
  egress:
  - to:
    - podSelector: {}
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-intra-namespace
  namespace: infrastructure
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - podSelector: {}
  egress:
  - to:
    - podSelector: {}

---
# Rule 5: ALLOW INGRESS-CONTROLLER
# Allow traffic from the Ingress Controller into the services.
# This assumes the ingress controller is in the 'kube-system' namespace.
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-ingress-controller
  namespace: graduate-project
spec:
  podSelector: {} # Apply to all pods
  policyTypes:
  - Ingress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          # This label is for the default k3s/Rancher ingress.
          # Change if your ingress controller has a different label.
          app.kubernetes.io/name: traefik
    - namespaceSelector:
        matchLabels:
          # Add other possible ingress labels here
          app.kubernetes.io/name: ingress-nginx
