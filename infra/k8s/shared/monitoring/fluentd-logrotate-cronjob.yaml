apiVersion: batch/v1
kind: CronJob
metadata:
  name: fluentd-logrotate
  namespace: monitoring
  labels:
    app: fluentd-logrotate
    tier: monitoring
spec:
  # Ch·∫°y m·ªói ng√†y l√∫c 2h s√°ng
  schedule: "0 2 * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: fluentd-logrotate
        spec:
          restartPolicy: OnFailure
          containers:
            - name: logrotate
              image: alpine:3.19
              command:
                - /bin/sh
                - -c
                - |
                  echo "üóëÔ∏è  Starting Fluentd log cleanup..."
                  
                  # X√≥a logs c≈© h∆°n 7 ng√†y
                  find /var/log/fluentd-output -name "kubernetes*.gz" -mtime +7 -delete
                  
                  # X√≥a buffer files c≈© h∆°n 3 ng√†y
                  find /tmp/fluentd-buffers -type f -mtime +3 -delete
                  
                  # Hi·ªÉn th·ªã disk usage sau khi d·ªçn
                  echo "üìä Disk usage after cleanup:"
                  du -sh /var/log/fluentd-output || echo "No output dir"
                  du -sh /tmp/fluentd-buffers || echo "No buffer dir"
                  
                  echo "‚úÖ Fluentd log cleanup completed"
              volumeMounts:
                - name: fluentd-output
                  mountPath: /var/log/fluentd-output
                - name: tmp
                  mountPath: /tmp
              resources:
                requests:
                  cpu: 10m
                  memory: 32Mi
                limits:
                  cpu: 50m
                  memory: 64Mi
          volumes:
            # Mount c√πng volumes v·ªõi Fluentd pods ƒë·ªÉ access logs
            - name: fluentd-output
              emptyDir:
                sizeLimit: 2Gi
            - name: tmp
              emptyDir:
                sizeLimit: 1Gi
